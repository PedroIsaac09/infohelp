{% extends "base.html" %}
{% load static %}

{% block title %}{{ curso.nome }}{% endblock title %}

{% block content %}
    <div class="container">
        <div class="titulo-pag">
            <h1>{{ curso.nome }}</h1>
        </div>
    </div>

    <section class="section-centeudo_curso container">
        <div class="curso-apresentacao">
            <div class="img-curso_pag">
                {% if curso.capa %}
                <img src="{{ curso.capa.url }}" alt="">
                {% else %}
                    <img src="{% static "assets/placeholder.png" %}" alt="Sem capa">
                {% endif %}
            </div>
            <div class="descricao-curso">{{ curso.descricao }}</div>
            <div class="num-conteudo">
                <p>0000 V√≠deos</p>
                <p>0000 Artigos</p>  
            </div>
            <div class="botao-salvar">
                
                <!-- Bot√£o para abrir o modal -->
                <button id="abrir-modal-salvar" data-curso-id="{{ curso.id }}">Carregando...</button>

                <!-- Bot√£o para remover o curso de todos os salvos -->
                <button id="remover-de-salvos" style="display: none;">Remover de Salvos</button>

                <!-- Modal para escolher ou criar cole√ß√£o -->
                <div id="modal-salvar">
                    <div class="modal">

                        <div class="selecionar-salvo">
                            <h3>Escolha uma cole√ß√£o para salvar</h3>
                            <div>
                                <!-- Lista de cole√ß√µes -->
                                <select id="colecao-salvos">
                                    <option value="">Carregando cole√ß√µes...</option>
                                </select>
                                
                                <!-- Bot√£o para salvar -->
                                <button id="confirmar-salvamento">Salvar</button>
                            </div>
                        </div>

                        <div class="criar-salvo">
                            <!-- Criar nova cole√ß√£o -->
                            <h4>ou crie uma nova cole√ß√£o.</h4>
                            <div>
                                <input type="text" id="nova-colecao-nome" placeholder="Nome da cole√ß√£o">
                                <button id="criar-nova-colecao">Criar</button>
                            </div>
                        </div>

                        <button onclick="document.getElementById('modal-salvar').style.display='none'" >Fechar</button>
                        
                    </div>
                </div>

            </div>
        </div>

        <div class="video_texto-curso">
            <!--N√£o est√° servindo
            <h1> {{ aula.curso }} 1</h1>
            -->
            <!-- Nome do curso
            <h1> {{ curso.nome }} 2</h1>
            -->
            <!-- Nome do curso sendo acessado pela aula
            <h1> {{ aula.curso.nome }} 3</h1>
            -->
            
            {% for aula in aula %}

                {% if curso.nome == aula.curso.nome %}
                <div>
                    <a href="{% url "detalhes_aula" curso.id aula.id %}" class="link-aula">
                        <div class="conteudo-curso">
                            <div class="img-conteudo_curso">
                                <img src="{{ aula.capa.url }}" alt="">
                            </div>
                            
                            <div class="titulo_desc-conteudo">
                                <h1>{{ aula.titulo }}</h1>
                                <p>{{ aula.descricao }}</p>
                            </div>
                        </div>
                    </a>
                </div>
                {% endif %}
                
            {% endfor %}

            <div class="adicionar-aula">
                <p>Adicione uma nova aula ao seu curso</p>
                
                <a href="{% url "criar_aula" curso.id %}">
                    <h1>Adicionar aula</h1>
                </a>
            </div>

        </div>
    </section>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            let cursoId = document.getElementById("abrir-modal-salvar").getAttribute("data-curso-id");
            let botaoSalvar = document.getElementById("abrir-modal-salvar");
            let botaoRemover = document.getElementById("remover-de-salvos");
        
            // Verificar se o curso j√° est√° salvo
            fetch(`/verificar_curso_salvo/${cursoId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.salvo) {
                    botaoSalvar.textContent = "Editar Salvos";
                    botaoRemover.style.display = "inline-block"; // Exibe o bot√£o de remover
                } else {
                    botaoSalvar.textContent = "Salvar";
                    botaoRemover.style.display = "none"; // Esconde o bot√£o de remover
                }
            });
        });
        
        // Abrir modal e carregar cole√ß√µes do usu√°rio
        document.getElementById("abrir-modal-salvar").addEventListener("click", function() {
            let cursoId = this.getAttribute("data-curso-id");
            let selectColecao = document.getElementById("colecao-salvos");
        
            selectColecao.innerHTML = "<option value=''>Carregando...</option>";
            
            fetch("/listar_colecoes_salvos/")
            .then(response => response.json())
            .then(data => {
                selectColecao.innerHTML = "";
                if (data.colecoes.length > 0) {
                    data.colecoes.forEach(colecao => {
                        let option = document.createElement("option");
                        option.value = colecao.id;
                        option.textContent = colecao.nome;
                        selectColecao.appendChild(option);
                    });
                } else {
                    selectColecao.innerHTML = "<option value=''>Nenhuma cole√ß√£o dispon√≠vel</option>";
                }
            });
        
            document.getElementById("modal-salvar").style.display = "block";
        });
        
        // Criar nova cole√ß√£o
        document.getElementById("criar-nova-colecao").addEventListener("click", function() {
            let nomeNovaColecao = document.getElementById("nova-colecao-nome").value;
        
            if (!nomeNovaColecao) {
                alert("Digite um nome para a cole√ß√£o!");
                return;
            }
        
            fetch("/criar_nova_colecao/", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: `nome=${nomeNovaColecao}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.id) {
                    let selectColecao = document.getElementById("colecao-salvos");
                    let option = document.createElement("option");
                    option.value = data.id;
                    option.textContent = data.nome;
                    selectColecao.appendChild(option);
                    selectColecao.value = data.id; // Seleciona automaticamente
                    alert("Cole√ß√£o criada com sucesso!");
                } else {
                    alert("Erro ao criar cole√ß√£o!");
                }
            });
        });
        
        // Salvar curso na cole√ß√£o escolhida
            document.getElementById("confirmar-salvamento").addEventListener("click", function() {
                let cursoId = document.getElementById("abrir-modal-salvar").getAttribute("data-curso-id");
                let salvosId = document.getElementById("colecao-salvos").value;

                if (!salvosId) {
                    alert("Escolha ou crie uma cole√ß√£o primeiro!");
                    return;
                }

                fetch("/salvar_curso/", {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: `curso_id=${cursoId}&salvos_id=${salvosId}`
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    document.getElementById("modal-salvar").style.display = "none";

                    // üî• Atualiza o bot√£o imediatamente ap√≥s salvar
                    let botaoSalvar = document.getElementById("abrir-modal-salvar");
                    let botaoRemover = document.getElementById("remover-de-salvos");

                    botaoSalvar.textContent = "Editar Salvos";
                    botaoRemover.style.display = "inline-block"; // Exibe o bot√£o de remover
                });
            });
        
        // Remover curso de todas as cole√ß√µes
        document.getElementById("remover-de-salvos").addEventListener("click", function() {
            let cursoId = document.getElementById("abrir-modal-salvar").getAttribute("data-curso-id");
        
            fetch("/remover_curso_de_salvos/", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: `curso_id=${cursoId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.removido) {
                    alert("Curso removido de todas as cole√ß√µes!");
                    document.getElementById("abrir-modal-salvar").textContent = "Salvar Curso";
                    document.getElementById("remover-de-salvos").style.display = "none"; // Esconde o bot√£o de remover
                } else {
                    alert("Erro ao remover curso!");
                }
            });
        });
        </script>
        
{% endblock content %}